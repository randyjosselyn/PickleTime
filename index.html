<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Pickleball Team Availability</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --green:#2c6e49; --green2:#3d8b63; --bg:#f7f7f7; }
    body { font-family: Arial, sans-serif; margin: 24px; background: var(--bg); }
    .container { max-width: 1000px; margin: 0 auto; background:#fff; padding: 24px; border-radius: 12px; box-shadow: 0 2px 12px rgba(0,0,0,.06); }
    h1 { margin: 0 0 8px; color:var(--green); font-size: 24px; }
    .toplinks { display:flex; gap:10px; margin-bottom:16px; }
    .toplinks a { color: var(--green); text-decoration:none; font-size:14px; }
    .badge { display:inline-block; background:#eef7f0; color:#2c6e49; padding:4px 10px; border-radius:999px; font-size:12px; margin-left:8px; }
    .section { margin: 18px 0; padding: 16px; background:#f4f4f4; border-radius:10px; }
    label { font-weight: bold; }
    select, input[type="text"] { width:100%; padding:10px; margin-top:8px; border:1px solid #ccc; border-radius:8px; font-size:14px; }
    table { width:100%; border-collapse: collapse; margin-top:10px; }
    th, td { border-bottom:1px solid #e9e9e9; padding:8px; text-align:left; vertical-align: top; }
    th { background:#fafafa; }
    .checks { display:flex; gap:12px; align-items:center; }
    .checks label { font-weight: normal; }
    button { padding:12px 16px; background:var(--green); color:#fff; border:none; border-radius:10px; font-size:16px; cursor:pointer; }
    button:hover { background:var(--green2); }
    .note { font-size: 12px; color:#666; }
    .success { color:#0a7d33; font-weight:bold; }
    .error { color:#b00020; font-weight:bold; }
    .coachnote { background:#fffbe6; border:1px solid #f0e6a2; padding:6px 10px; border-radius:8px; white-space:pre-wrap; }
    .actions { display:flex; gap:10px; align-items:center; }
    .right { text-align:right; }
    .nowrap { white-space: nowrap; }
    .controls-row { display:flex; gap:16px; align-items:center; justify-content: space-between; flex-wrap: wrap; }
  </style>
</head>
<body>
<div class="container">
  <div class="toplinks">
    <a href="./admin.html">Go to Admin Dashboard →</a>
  </div>
  <h1>Pickleball Team Availability <span id="divBadge" class="badge"></span></h1>
  <p class="note">Select your name, pick next week’s practice windows (multiple per day), and update game availability.</p>

  <!-- Player selector -->
  <div class="section">
    <label for="player">Player Name</label>
    <select id="player"><option value="">Loading roster…</option></select>
    <div id="rosterFallback" class="note" style="display:none;margin-top:8px;">
      Couldn’t load the roster. You can type your name:
      <input type="text" id="playerText" placeholder="Your name" />
    </div>
  </div>

  <!-- Practice section -->
  <div class="section">
    <div class="controls-row">
      <div>
        <label>Are you available to practice next week?</label>
        <div class="note" id="weekRangeNote">—</div>
      </div>
      <div class="right"><button id="submitPracticeBtn">Save Practice Availability</button></div>
    </div>
    <table id="weekTable">
      <thead>
        <tr>
          <th>Day</th><th>Date</th><th>6–8 AM</th><th>8–10 AM</th><th>12–2 PM</th><th>7–10 PM</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <p id="practiceStatus" class="note" style="margin-top:8px;"></p>
  </div>

  <!-- Games section: radio Yes/No per game + Save All -->
  <div class="section">
    <div class="controls-row">
      <div>
        <label>Game Availability</label>
        <div class="note" id="gamesNote">(Listing scheduled games for your division. BYE weeks are hidden.)</div>
      </div>
      <label class="note"><input type="checkbox" id="showPast"> Show past dates</label>
    </div>
    <table id="gamesTable">
      <thead>
        <tr>
          <th>Day</th>
          <th>Date</th>
          <th>Time</th>
          <th>Coach Note</th>
          <th colspan="2" class="nowrap">Available</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <div class="actions" style="margin-top:10px;">
      <button id="saveGamesBtn">Save All Game Responses</button>
      <span id="gamesStatus" class="note"></span>
    </div>
  </div>
</div>

<script>
  // ====== CONFIG ======
  const API_URL = "https://round-fog-5a5e.randyjosselyn.workers.dev/";
  const params = new URLSearchParams(location.search);
  const DIVISION = (params.get('div') || 'D4').toUpperCase();

  // ====== Date helpers ======
  function startOfNextWeek(){ const d=new Date(); const day=d.getDay(); const add=(7-day)%7 || 7; d.setDate(d.getDate()+add); d.setHours(0,0,0,0); return d; }
  function ymd(d){ const y=d.getFullYear(); const m=String(d.getMonth()+1).padStart(2,'0'); const dd=String(d.getDate()).padStart(2,'0'); return `${y}-${m}-${dd}`; }
  function formatHuman(d){ return d.toLocaleDateString(undefined,{weekday:'short',month:'short',day:'numeric'}); }
  function displayStart(v){
    if (v==null) return '—';
    const t = String(v).trim();
    if (!t) return '—';
    const U = t.toUpperCase();
    if (U==='TOURNAMENT') return 'TOURNAMENT';
    if (U==='TBD') return 'TBD';
    // Extract HH:MM if present anywhere (handles 1899 date strings from Sheets)
    const m = t.match(/(\b\d{1,2}):(\d{2})/);
    if (m) return `${m[1].padStart(2,'0')}:${m[2]}`;
    // If parseable as Date string, format time
    const d = new Date(t);
    if (!isNaN(d)) return `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
    return t;
  }

  // ====== Build practice week table (Sun–Fri) ======
  function buildWeekTable(){
    const tbody=document.querySelector('#weekTable tbody'); tbody.innerHTML='';
    const start=startOfNextWeek(); const days=['Sun','Mon','Tue','Wed','Thu','Fri'];
    const end=new Date(start); end.setDate(start.getDate()+5);
    document.getElementById('weekRangeNote').textContent=`(${formatHuman(start)} – ${formatHuman(end)})`;
    for(let i=0;i<6;i++){
      const d=new Date(start); d.setDate(start.getDate()+i);
      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td>${days[i]}</td>
        <td data-date="${ymd(d)}">${formatHuman(d)}</td>
        <td><input type="checkbox" data-slot="p68"></td>
        <td><input type="checkbox" data-slot="p810"></td>
        <td><input type="checkbox" data-slot="p122"></td>
        <td><input type="checkbox" data-slot="p710"></td>
      `;
      tbody.appendChild(tr);
    }
  }

  // ====== Roster ======
  async function loadRoster(){
    document.getElementById('divBadge').textContent=`Division ${DIVISION}`;
    const playerSel=document.getElementById('player');
    const fallback=document.getElementById('rosterFallback');
    try{
      const res=await fetch(API_URL,{ method:'POST', headers:{'Content-Type':'application/json;charset=utf-8'}, body: JSON.stringify({ action:'roster', division: DIVISION }) });
      const json=await res.json();
      const roster=Array.isArray(json?.roster)?json.roster:[];
      playerSel.innerHTML=`<option value="">Select…</option>`;
      if(!roster.length){ fallback.style.display='block'; }
      else{
        roster.forEach(r=>{ const opt=document.createElement('option'); opt.value=r.player; opt.textContent=r.player; playerSel.appendChild(opt); });
        fallback.style.display='none';
      }
    }catch(e){
      playerSel.innerHTML=`<option value="">(Roster unavailable)</option>`;
      fallback.style.display='block';
    }
  }

  // ====== Season + GameDays ======
  let GAME_LIST = []; // {date, start, note}
  function isPastISO(iso){
    const today = new Date(); today.setHours(0,0,0,0);
    const d = new Date(iso+'T00:00:00');
    return d < today;
  }
  async function loadSeasonAndGameDays(){
    try{
      const res = await fetch(API_URL, { method:'POST', headers:{'Content-Type':'application/json;charset=utf-8'}, body: JSON.stringify({ action:'getsettings', division: DIVISION }) });
      const j=await res.json();
      const g=Array.isArray(j.gamedays)? j.gamedays: [];
      GAME_LIST = g.filter(x => (x.IsBye==='No'))
                   .map(x => ({ date: x.Date, start: x.Start||'', note: x.CoachNote||'' }))
                   .sort((a,b)=> a.date.localeCompare(b.date));
      renderGamesTable();
    }catch(e){
      document.getElementById('gamesNote').textContent='(Could not load season schedule.)';
      GAME_LIST = [];
      renderGamesTable();
    }
  }

  function renderGamesTable(playerAvailabilityMap){
    const tb = document.querySelector('#gamesTable tbody');
    tb.innerHTML='';
    const existing = playerAvailabilityMap || new Map(); // key: date -> 'Yes'|'No'
    const showPast = document.getElementById('showPast').checked;
    const source = GAME_LIST.filter(g => showPast || !isPastISO(g.date));
    source.forEach(g => {
      const avail = existing.get(g.date) || '';
      const d = new Date(g.date+'T00:00:00');
      const tr=document.createElement('tr');
      tr.innerHTML = `
        <td class="nowrap">${d.toLocaleDateString(undefined,{weekday:'short'})}</td>
        <td class="nowrap">${d.toLocaleDateString(undefined,{month:'short',day:'numeric',year:'numeric'})}</td>
        <td class="nowrap">${displayStart(g.start)}</td>
        <td>${g.note? `<div class="coachnote">${g.note}</div>`:''}</td>
        <td class="nowrap"><label><input type="radio" name="avail-${g.date}" value="Yes" ${avail==='Yes'?'checked':''}/> Yes</label></td>
        <td class="nowrap"><label><input type="radio" name="avail-${g.date}" value="No"  ${avail==='No'?'checked':''}/> No</label></td>
      `;
      tb.appendChild(tr);
    });
  }

  // Build availability map for the selected player from DATA rows
  function latestGameAvailabilityByDate(rows, player){
    const map = new Map(); // date -> {ts,val}
    rows.forEach(r => {
      if ((r['Type']||'').toString().toLowerCase()!=='game') return;
      const p = (r['Player']||'').toString().trim();
      const div = (r['Division']||'').toString().trim().toUpperCase();
      if (p!==player || div!==DIVISION) return;
      const date = (r['Game Date']||'').toString().trim();
      if (!date) return;
      const ts = new Date(r['Timestamp']).getTime()||0;
      const val = (r['Available for Game?']||'').toString().trim() || 'No';
      const curr = map.get(date);
      if (!curr || ts>curr.ts) map.set(date,{ts, val});
    });
    const out = new Map();
    map.forEach((v,k)=> out.set(k, v.val));
    return out;
  }

  async function refreshPlayerGameSelections(){
    const playerSel=document.getElementById('player');
    const playerText=document.getElementById('playerText');
    const player = playerSel.value || (playerText?playerText.value.trim():'');
    if (!player){ renderGamesTable(new Map()); return; }
    try{
      const res = await fetch(API_URL,{ method:'POST', headers:{'Content-Type':'application/json;charset=utf-8'}, body: JSON.stringify({ action:'read', division: DIVISION }) });
      const json = await res.json();
      const rows = json.rows || [];
      const map = latestGameAvailabilityByDate(rows, player);
      renderGamesTable(map);
    }catch(e){ renderGamesTable(new Map()); }
  }

  async function savePractice(){
    const status=document.getElementById('practiceStatus'); status.textContent='';
    const playerSel=document.getElementById('player'); const playerText=document.getElementById('playerText');
    const player=playerSel.value || (playerText?playerText.value.trim():'');
    if(!player){ status.innerHTML='<span class="error">Please select or enter your name.</span>'; return; }

    const rows=[]; const tbody=document.querySelector('#weekTable tbody');
    [...tbody.rows].forEach(tr=>{
      const dayLabel=tr.cells[0].textContent.trim();
      const date=tr.cells[1].getAttribute('data-date');
      const p68=tr.querySelector('input[data-slot="p68"]').checked;
      const p810=tr.querySelector('input[data-slot="p810"]').checked;
      const p122=tr.querySelector('input[data-slot="p122"]').checked;
      const p710=tr.querySelector('input[data-slot="p710"]').checked;
      if(p68||p810||p122||p710) rows.push({ day:dayLabel, date, p68, p810, p122, p710 });
    });

    try{
      if(rows.length){
        await fetch(API_URL,{ method:'POST', headers:{'Content-Type':'application/json;charset=utf-8'}, body: JSON.stringify({ action:'submitweek', player, division: DIVISION, week: rows }) });
      }
      status.innerHTML='<span class="success">Practice availability saved.</span>';
    }catch(e){ status.innerHTML='<span class="error">Network or server error. Please try again.</span>'; }
  }

  async function saveAllGames(){
    const status=document.getElementById('gamesStatus'); status.textContent='';
    const playerSel=document.getElementById('player'); const playerText=document.getElementById('playerText');
    const player=playerSel.value || (playerText?playerText.value.trim():'');
    if(!player){ status.innerHTML='<span class="error">Please select or enter your name.</span>'; return; }

    const updates = [];
    GAME_LIST.forEach(g => {
      const showPast = document.getElementById('showPast').checked;
      if (!showPast && isPastISO(g.date)) return; // we didn't show it, don't save it either
      const yes = document.querySelector(`input[name="avail-${g.date}"][value="Yes"]`);
      const no  = document.querySelector(`input[name="avail-${g.date}"][value="No"]`);
      const val = yes?.checked ? 'Yes' : (no?.checked ? 'No' : '');
      if (val) updates.push({ date:g.date, val });
    });

    if (!updates.length){ status.textContent='No changes to save.'; return; }

    try{
      await Promise.all(updates.map(u =>
        fetch(API_URL,{ method:'POST', headers:{'Content-Type':'application/json;charset=utf-8'}, body: JSON.stringify({ action:'submitgame', player, division: DIVISION, game_date:u.date, game_available:u.val }) })
      ));
      status.innerHTML = `<span class="success">Saved ${updates.length} update(s).</span>`;
    }catch(e){ status.innerHTML='<span class="error">Network or server error. Please try again.</span>'; }
  }

  function init(){
    buildWeekTable();
    loadRoster().then(()=>refreshPlayerGameSelections());
    loadSeasonAndGameDays().then(()=>refreshPlayerGameSelections());
    document.getElementById('player').addEventListener('change', refreshPlayerGameSelections);
    const pt=document.getElementById('playerText'); if (pt) pt.addEventListener('blur', refreshPlayerGameSelections);
    document.getElementById('submitPracticeBtn').addEventListener('click', savePractice);
    document.getElementById('saveGamesBtn').addEventListener('click', saveAllGames);
    document.getElementById('showPast').addEventListener('change', ()=>refreshPlayerGameSelections());
  }
  init();
</script>
</body>
</html>
