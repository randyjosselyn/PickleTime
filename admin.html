<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Pickleball Admin Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --green:#2c6e49; --green2:#3d8b63; --bg:#f7f7f7; }
    body { font-family: Arial, sans-serif; margin: 24px; background: var(--bg); }
    .container { max-width: 1100px; margin: 0 auto; background:#fff; padding: 24px; border-radius: 12px; box-shadow: 0 2px 12px rgba(0,0,0,.06); }
    h1 { margin: 0 0 8px; color:var(--green); font-size: 24px; }
    .toplinks { display:flex; gap:10px; margin-bottom:16px; }
    .toplinks a { color: var(--green); text-decoration:none; font-size:14px; }
    .card { background:#f4f4f4; border-radius:10px; padding:16px; margin:16px 0; }
    .card h3 { margin:0 0 8px; font-size:16px; }
    table { width:100%; border-collapse: collapse; }
    th, td { border-bottom:1px solid #eee; padding:8px; text-align:left; }
    th { background:#fafafa; }
    .small { font-size:12px; color:#666; }
    .counts { font-weight:bold; }
    .btn { display:inline-block; padding:10px 12px; background:var(--green); color:#fff; border:none; border-radius:8px; cursor:pointer; font-size:14px; }
    .btn:hover { background:var(--green2); }
  </style>
</head>
<body>
<div class="container">
  <div class="toplinks">
    <a href="./index.html">← Player Form</a>
  </div>
  <h1>Admin Dashboard</h1>
  <div class="small" id="updatedAt">Loading…</div>

  <div class="card">
    <h3>Next Week — Practice Availability (Sun–Fri)</h3>
    <div class="small" id="weekRangeNote">—</div>
    <table id="weekTable">
      <thead>
        <tr>
          <th>Day</th>
          <th>Date</th>
          <th>8–10 AM (count)</th>
          <th>12–2 PM (count)</th>
          <th>6–10 PM (count)</th>
          <th>Players</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="card">
    <h3>Saturday Game Availability</h3>
    <div class="small">From next Saturday through end of May 2026</div>
    <table id="gamesTable">
      <thead>
        <tr>
          <th>Date</th>
          <th># Available</th>
          <th>Players</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <button class="btn" id="refreshBtn">Refresh</button>
</div>

<script>
  // ====== CONFIG ======
  const API_URL = "https://script.google.com/macros/s/AKfycby0IuJ4705OwS2CM2henGcK_3wnvfoJ6xIarL8TQLlG1uRJaNt-HdkPtMxh-iC_3D1s/exec"; // e.g., your Cloudflare Worker URL

  // ====== Date helpers ======
  function ymd(d) {
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,'0');
    const dd = String(d.getDate()).padStart(2,'0');
    return `${y}-${m}-${dd}`;
  }
  function startOfNextWeek() {
    const d = new Date();
    const day = d.getDay(); // 0=Sun
    const add = (7 - day) % 7 || 7;
    d.setDate(d.getDate() + add);
    d.setHours(0,0,0,0);
    return d;
  }
  function nextSaturday(fromDate) {
    const d = new Date(fromDate);
    const day = d.getDay();
    const offset = (6 - day + 7) % 7 || 7;
    d.setDate(d.getDate() + offset);
    d.setHours(0,0,0,0);
    return d;
  }
  function saturdaysThroughMay2026() {
    const end = new Date(2026, 4, 31);
    const out = [];
    let cur = nextSaturday(new Date());
    while (cur <= end) {
      out.push(new Date(cur));
      cur.setDate(cur.getDate() + 7);
    }
    return out;
  }

  // ====== Fetch ======
  async function fetchAll() {
    const res = await fetch(API_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain;charset=utf-8' },
      body: JSON.stringify({ action: 'read' })
    });
    return res.json();
  }

  // ====== Aggregations ======
  function latestPracticeByPlayerDate(rows) {
    // Map key: player|date (Practice Date), only Type='practice'
    const map = new Map();
    rows.forEach(r => {
      const type = (r['Type'] || '').toString().toLowerCase();
      if (type !== 'practice') return;
      const player = (r['Player'] || '').toString().trim();
      const date = (r['Practice Date'] || '').toString().trim();
      if (!player || !date) return;
      const ts = new Date(r['Timestamp']).getTime() || 0;
      const key = `${player}|${date}`;
      const curr = map.get(key);
      if (!curr || ts > curr.ts) {
        map.set(key, {
          ts,
          p810: r['Practice: 8-10 AM'] ? true : false,
          p122: r['Practice: 12-2 PM'] ? true : false,
          p610: r['Practice: 6-10 PM'] ? true : false,
          day: (r['Day'] || '').toString().trim()
        });
      }
    });
    return map;
  }

  function aggregateWeek(map, start) {
    // Build Sun–Fri dates
    const days = ['Sun','Mon','Tue','Wed','Thu','Fri'];
    const week = [];
    for (let i=0; i<6; i++) {
      const d = new Date(start); d.setDate(start.getDate()+i);
      week.push({ label: days[i], iso: ymd(d), names810: new Set(), names122: new Set(), names610: new Set() });
    }
    // Fill sets
    map.forEach((rec, key) => {
      const [player, date] = key.split('|');
      const w = week.find(x => x.iso === date);
      if (!w) return; // Only show next week
      if (rec.p810) w.names810.add(player);
      if (rec.p122) w.names122.add(player);
      if (rec.p610) w.names610.add(player);
    });
    return week;
  }

  function latestGameByPlayerDate(rows) {
    const map = new Map();
    rows.forEach(r => {
      const type = (r['Type'] || '').toString().toLowerCase();
      if (type !== 'game') return;
      const player = (r['Player'] || '').toString().trim();
      const date = (r['Game Date'] || '').toString().trim();
      if (!player || !date) return;
      const ts = new Date(r['Timestamp']).getTime() || 0;
      const key = `${player}|${date}`;
      const curr = map.get(key);
      if (!curr || ts > curr.ts) {
        map.set(key, { ts, yes: ((r['Available for Game?'] || '').toString().trim().toLowerCase() === 'yes') });
      }
    });
    // By date
    const byDate = new Map();
    map.forEach((rec, key) => {
      const [player, date] = key.split('|');
      if (rec.yes) {
        if (!byDate.has(date)) byDate.set(date, new Set());
        byDate.get(date).add(player);
      }
    });
    return byDate;
  }

  // ====== Render ======
  function renderWeek(week, start) {
    const tb = document.querySelector('#weekTable tbody');
    tb.innerHTML = '';
    const end = new Date(start); end.setDate(start.getDate()+5);
    document.getElementById('weekRangeNote').textContent =
      `${start.toLocaleDateString(undefined,{month:'short',day:'numeric'})} – ${end.toLocaleDateString(undefined,{month:'short',day:'numeric'})}`;

    week.forEach(day => {
      const players = new Set([...day.names810, ...day.names122, ...day.names610]);
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${day.label}</td>
        <td>${new Date(day.iso + 'T00:00:00').toLocaleDateString(undefined, { month:'short', day:'numeric' })}</td>
        <td class="counts">${day.names810.size}</td>
        <td class="counts">${day.names122.size}</td>
        <td class="counts">${day.names610.size}</td>
        <td>${[...players].sort().join(', ')}</td>
      `;
      tb.appendChild(tr);
    });
  }

  function renderGames(byDate) {
    const tb = document.querySelector('#gamesTable tbody');
    tb.innerHTML = '';
    const allSats = saturdaysThroughMay2026().map(d => ymd(d));
    allSats.forEach(date => {
      const players = byDate.get(date) ? [...byDate.get(date)].sort() : [];
      const tr = document.createElement('tr');
      const human = new Date(date + 'T00:00:00').toLocaleDateString(undefined, { weekday:'short', month:'short', day:'numeric', year:'numeric' });
      tr.innerHTML = `
        <td>${human}</td>
        <td class="counts">${players.length}</td>
        <td>${players.join(', ')}</td>
      `;
      tb.appendChild(tr);
    });
  }

  async function refresh() {
    document.getElementById('updatedAt').textContent = 'Loading…';
    try {
      const json = await fetchAll();
      const rows = (json && json.rows) ? json.rows : [];

      // Practice aggregation for next week
      const start = startOfNextWeek();
      const latestMap = latestPracticeByPlayerDate(rows);
      const week = aggregateWeek(latestMap, start);
      renderWeek(week, start);

      // Games aggregation
      const gamesByDate = latestGameByPlayerDate(rows);
      renderGames(gamesByDate);

      document.getElementById('updatedAt').textContent =
        `Updated: ${new Date(json.updatedAt || Date.now()).toLocaleString()}`;
    } catch (e) {
      document.getElementById('updatedAt').textContent = 'Failed to load data.';
    }
  }

  document.getElementById('refreshBtn').addEventListener('click', refresh);
  refresh();
</script>
</body>
</html>
